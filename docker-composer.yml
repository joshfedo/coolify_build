# docker-compose.yml - Fully Parameterized for Version Control with Preview DB Cloning
version: '3.8'
services:
  magento:
    # Use variables for the image tag. Defaults to php8.2-nginx.
    image: shinsenter/magento:${PHP_IMAGE_TAG:-php8.2-nginx}
    networks:
      - magento-network
      - coolify-network
    volumes:
      - magento-code:/var/www/html
    environment:
      # All your existing environment variables for setup
      - M2_DB_HOST=db
      - M2_DB_NAME=${COOLIFY_DATABASE_NAME:-magento}
      - M2_DB_USER=${COOLIFY_DATABASE_USER:-magento}
      - M2_DB_PASSWORD=${COOLIFY_DATABASE_PASSWORD:-magento_password}
      - M2_REDIS_HOST=redis
      - M2_SEARCH_ENGINE=opensearch
      - M2_OPENSEARCH_HOST=opensearch
      - M2_BASE_URL=https://${COOLIFY_FQDN:-localhost}/
      - M2_ADMIN_USER=${COOLIFY_ENV_ADMIN_USER:-admin}
      - M2_ADMIN_PASSWORD=${COOLIFY_ENV_ADMIN_PASSWORD:-Password123!}
      # Preview environment indicator
      - COOLIFY_PREVIEW_DEPLOYMENT=${COOLIFY_PREVIEW_DEPLOYMENT}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.magento-poc.rule=Host(`${COOLIFY_FQDN}`)"
      - "traefik.http.routers.magento-poc.entrypoints=websecure"
      - "traefik.http.routers.magento-poc.tls=true"
      - "traefik.http.routers.magento-poc.tls.certresolver=letsencrypt"
      - "traefik.http.services.magento-poc.loadbalancer.server.port=80"
    depends_on:
      - db
      - redis
      - opensearch

  db:
    # Build from the db directory
    build:
      context: ./db
      args:
        MARIADB_VERSION: ${DB_IMAGE_TAG:-10.6}
    networks:
      - magento-network
    environment:
      - MYSQL_ROOT_PASSWORD=${COOLIFY_DATABASE_ROOT_PASSWORD:-root_password}
      - MYSQL_DATABASE=${COOLIFY_DATABASE_NAME:-magento}
      - MYSQL_USER=${COOLIFY_DATABASE_USER:-magento}
      - MYSQL_PASSWORD=${COOLIFY_DATABASE_PASSWORD:-magento_password}
      - COOLIFY_PREVIEW_DEPLOYMENT=${COOLIFY_PREVIEW_DEPLOYMENT}
    volumes:
      - dbdata:/var/lib/mysql
      - db-backups:/backups

  db-backup:
    # Build from the backup directory
    build:
      context: ./backup
      args:
        MARIADB_VERSION: ${DB_IMAGE_TAG:-10.6}
    networks:
      - magento-network
    volumes:
      - db-backups:/backups
    environment:
      - MYSQL_DATABASE=${COOLIFY_DATABASE_NAME:-magento}
      - MYSQL_USER=${COOLIFY_DATABASE_USER:-magento}
      - MYSQL_PASSWORD=${COOLIFY_DATABASE_PASSWORD:-magento_password}
      - COOLIFY_PREVIEW_DEPLOYMENT=${COOLIFY_PREVIEW_DEPLOYMENT}
    restart: always

  opensearch:
    # Use a variable for the OpenSearch version. Defaults to 2.5.0.
    image: opensearchproject/opensearch:${OPENSEARCH_IMAGE_TAG:-2.5.0}
    networks:
      - magento-network
    environment:
      - "discovery.type=single-node"
      - "plugins.security.disabled=true"

  redis:
    # Use a variable for the Redis version. Defaults to 6.2-alpine.
    image: redis:${REDIS_IMAGE_TAG:-6.2-alpine}
    networks:
      - magento-network

networks:
  magento-network:
  coolify-network:
    name: coolify
    external: true

volumes:
  dbdata:
  magento-code:
  db-backups: